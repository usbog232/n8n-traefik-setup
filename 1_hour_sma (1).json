{
  "name": "1 hour+sma",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "61984442-5bda-42b7-9857-95504d376125",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        -1120,
        220
      ],
      "webhookId": "3e6f3793-1deb-4f9f-a07c-d081d1211385",
      "credentials": {
        "telegramApi": {
          "id": "hIRaaAjhIdI4Vd4r",
          "name": "cointest"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "userInputRaw",
              "value": "={{$json[\"message\"][\"text\"]}}"
            },
            {
              "name": "userInputLower",
              "value": "={{$json[\"message\"][\"text\"].toLowerCase()}}"
            },
            {
              "name": "chatId",
              "value": "={{$json[\"message\"][\"chat\"][\"id\"]}}"
            },
            {
              "name": "userInputUpper",
              "value": "={{ $json[\"message\"][\"text\"].trim().toUpperCase().replace(/[^A-Z0-9]/g, \"\") + \"USDT\" }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ce491d23-cd2a-4987-a20d-349ad612925d",
      "name": "Set Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -960,
        220
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json[\"isValid\"]}}",
              "value2": true
            }
          ]
        }
      },
      "id": "d8c6559b-17ce-4d2e-ac4d-e456d3092355",
      "name": "IF Valid?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -640,
        220
      ]
    },
    {
      "parameters": {
        "chatId": "={{$json[\"chatId\"]}}",
        "text": "=âœ… å·²è¯†åˆ«ä¸º {{$json[\"userInputLower\"]}}ï¼Œæ­£åœ¨è¿›è¡ŒåŠ å¯†è´§å¸åˆ†æ...",
        "additionalFields": {}
      },
      "id": "26c361ae-47e5-43f1-aed0-3a2bdfa33a68",
      "name": "Valid Response",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        -500,
        20
      ],
      "webhookId": "8d7bcfbf-577e-459c-b98b-adb9fe625dc7",
      "credentials": {
        "telegramApi": {
          "id": "hIRaaAjhIdI4Vd4r",
          "name": "cointest"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{$json[\"chatId\"]}}",
        "text": "âš ï¸ æš‚ä¸æ”¯æŒè¯¥å¸ç§ï¼Œè¯·è¾“å…¥å¦‚ ethã€btcã€solã€arb...",
        "additionalFields": {}
      },
      "id": "bed3654e-b33c-4267-9c0c-d27c66a4c9c8",
      "name": "Invalid Response",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        -480,
        320
      ],
      "webhookId": "981b5b39-b10a-4bb4-bb02-5a7e6df89ad8",
      "credentials": {
        "telegramApi": {
          "id": "hIRaaAjhIdI4Vd4r",
          "name": "cointest"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// âœ… Check Token in Array èŠ‚ç‚¹ä»£ç æ›´æ–°ä¸ºå‰ 200 çš„ä¸»æµå¸ç§æ”¯æŒéªŒè¯\nconst validTokens = [\n  \"btc\", \"eth\", \"bnb\", \"sol\", \"usdt\", \"usdc\", \"xrp\", \"doge\", \"ton\", \"ada\",\n  \"avax\", \"shib\", \"dot\", \"trx\", \"link\", \"wbtc\", \"matic\", \"uni\", \"bch\", \"ltc\",\n  \"near\", \"leo\", \"cro\", \"dai\", \"icp\", \"apt\", \"fil\", \"steth\", \"xmr\", \"atom\",\n  \"okb\", \"etc\", \"imx\", \"hbar\", \"rndr\", \"egld\", \"vet\", \"mantle\", \"ar\", \"ftm\",\n  \"kas\", \"op\", \"gala\", \"aave\", \"inj\", \"algo\", \"qnt\", \"flow\", \"sui\", \"tao\",\n  \"mina\", \"jito\", \"theta\", \"mkr\", \"snx\", \"bgb\", \"rpl\", \"kava\", \"chz\", \"xdai\",\n  \"zil\", \"ens\", \"blur\", \"bat\", \"one\", \"magic\", \"xec\", \"ocean\", \"render\", \"zrx\",\n  \"woo\", \"cvx\", \"amp\", \"band\", \"comp\", \"celo\", \"lpt\", \"yfi\", \"num\", \"ankr\",\n  \"cake\", \"bnt\", \"ziliqa\", \"ond\", \"nexo\", \"sfp\", \"qtum\", \"ckb\", \"rvn\", \"ogn\",\n  \"waves\", \"hnt\", \"storj\", \"api3\", \"fet\", \"agix\", \"lrc\", \"bico\", \"nxra\", \"bal\",\n  \"skl\", \"strk\", \"fxs\", \"hashflow\", \"movr\", \"bonk\", \"santos\", \"gas\", \"super\",\n  \"ssv\", \"joe\", \"astrafer\", \"ach\", \"ogn\", \"ogn\", \"ela\", \"nmr\", \"polyx\", \"id\",\n  \"mdx\", \"raca\", \"vra\", \"nkn\", \"xyo\", \"ever\", \"quack\", \"pundix\", \"glm\", \"spell\",\n  \"dar\", \"vtho\", \"tru\", \"trb\", \"dydx\", \"dexe\", \"umb\", \"inj\", \"mxc\", \"rep\",\n  \"barn\", \"pros\", \"lina\", \"data\", \"lina\", \"gmx\", \"sxp\", \"bel\", \"vite\", \"asto\",\n  \"ali\", \"oxt\", \"boba\", \"waxp\", \"reef\", \"nav\", \"xcn\", \"kmd\", \"krl\", \"slp\"\n];\n\nconst userInput = $json[\"userInputLower\"] || \"\";\nconst chatId = $json[\"chatId\"] || \"\";\n\nreturn [\n  {\n    json: {\n      chatId,\n      userInputLower: userInput,\n      isValid: validTokens.includes(userInput)\n    }\n  }\n];"
      },
      "id": "770cd4b2-817b-4277-84a3-4a6a81021c7d",
      "name": "Check Token in Array",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -800,
        220
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.aiPrompt }}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        500,
        360
      ],
      "id": "84b7d1d3-c050-4a06-9154-08ad6d17f8e4",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "model": "deepseek-r1:1.5b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        600,
        600
      ],
      "id": "f95b306e-a0fe-42ac-8cc6-232d1d1548ea",
      "name": "Ollama Model",
      "credentials": {
        "ollamaApi": {
          "id": "xyFHlhcsAfJf9g6B",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{$node[\"Set Variables\"].json[\"chatId\"]}}",
        "text": "=ğŸ“Š AI åˆ†ææŠ¥å‘Šå¦‚ä¸‹ï¼š\\n\\n{{$node[\"Basic LLM Chain\"].json[\"text\"]}}\n",
        "additionalFields": {}
      },
      "name": "Send Analysis To Telegram1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        860,
        360
      ],
      "id": "c3cc26a7-4de7-4aab-a199-3927b74afef3",
      "webhookId": "80428058-b37f-4644-97d4-dcb8ac5d5308",
      "credentials": {
        "telegramApi": {
          "id": "hIRaaAjhIdI4Vd4r",
          "name": "cointest"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-1.5-pro-001",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        440,
        140
      ],
      "id": "11845a4a-b19d-47a8-8ad5-c029e5169e10",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "Nm2skPr2xCGEvgZw",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.aiPrompt }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [
        420,
        -40
      ],
      "id": "1fa2ea89-40f4-4239-8ce1-e6559ef23765",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "chatId": "={{$node[\"Set Variables\"].json[\"chatId\"]}}",
        "text": "=ğŸ¤– AI åˆ†ææŠ¥å‘Šå¦‚ä¸‹ï¼š\\n\\n{{ $node[\"Code\"].json[\"text\"] }}\n\n",
        "additionalFields": {
          "parse_mode": "=HTML"
        }
      },
      "name": "Send Analysis To Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        880,
        -80
      ],
      "id": "346c48b4-ea3d-4423-9fd1-4f9ebdf38971",
      "webhookId": "80428058-b37f-4644-97d4-dcb8ac5d5308",
      "credentials": {
        "telegramApi": {
          "id": "hIRaaAjhIdI4Vd4r",
          "name": "cointest"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const raw = $json.output;\n\n// HTML è½¬ä¹‰\nconst escapeHTML = str => str\n  .replace(/&/g, \"&amp;\")\n  .replace(/</g, \"&lt;\")\n  .replace(/>/g, \"&gt;\");\n\n// å¤„ç†åŠ ç²—å’Œæ¢è¡Œ â†’ æ³¨æ„ `<br/>` é—­åˆæ ‡ç­¾\nconst htmlText = escapeHTML(raw)\n  .replace(/\\*\\*(.*?)\\*\\*/g, \"<b>$1</b>\")\n  .replace(/\\\\n/g, \"<br/>\");\n\nreturn [\n  {\n    json: {\n      text: htmlText\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        740,
        -80
      ],
      "id": "5a5f679a-c8c5-4d5a-aa4c-a8623718ccdd",
      "name": "Code"
    },
    {
      "parameters": {
        "mode": "mergeByIndex"
      },
      "id": "904772b1-3eb4-4777-ab5d-7cc392a0272b",
      "name": "Merge 2 (1D+1W)4",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        -40,
        280
      ]
    },
    {
      "parameters": {
        "mode": "mergeByIndex"
      },
      "id": "5d3d1825-7446-44fb-82c4-36f52bfb31d2",
      "name": "Merge 2 (1D+1W)5",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        80,
        160
      ]
    },
    {
      "parameters": {
        "mode": "mergeByIndex"
      },
      "id": "aeecf552-f828-4130-829a-fabce8ed1ce2",
      "name": "Merge 2 (1D+1W)6",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        -20,
        20
      ]
    },
    {
      "parameters": {
        "mode": "mergeByIndex"
      },
      "id": "7f7e4f7d-1ad7-43f1-bca5-e8fe2c33cf6f",
      "name": "Merge 2 (1D+1W)",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        180,
        20
      ]
    },
    {
      "parameters": {
        "functionCode": "// âœ… åŸå§‹ Bybit Kçº¿æ•°æ®\nconst klineList = $json.result?.list || [];\n\n// æ”¶ç›˜ä»·ä¸æ—¶é—´æˆ³ï¼ˆä»æ–°åˆ°æ—§ï¼‰\nconst closes = klineList.map(k => parseFloat(k[4]));\nconst timestamps = klineList.map(k => parseInt(k[0]));\nconst limit = closes.length;\n\n// âœ… è½¬ä¸ºä»æ—§åˆ°æ–°ï¼ˆç”¨äºSMAè®¡ç®—ï¼‰\nconst closesReversed = closes.slice().reverse();\nconst timestampsReversed = timestamps.slice().reverse();\n\n// âœ… SMAè®¡ç®—å‡½æ•°ï¼ˆæ»‘åŠ¨å¹³å‡ï¼‰\nfunction calculateSMA(data, period) {\n  const sma = [];\n  for (let i = 0; i < data.length; i++) {\n    if (i < period - 1) {\n      sma.push(null);\n    } else {\n      const slice = data.slice(i - period + 1, i + 1);\n      const sum = slice.reduce((a, b) => a + b, 0);\n      sma.push(parseFloat((sum / period).toFixed(4)));\n    }\n  }\n  return sma;\n}\n\n// âœ… è®¡ç®— SMA å€¼ï¼ˆå¹¶åè½¬å›æ¥ï¼‰\nconst sma14 = calculateSMA(closesReversed, 14).reverse();\nconst sma28 = calculateSMA(closesReversed, 28).reverse();\nconst sma60 = calculateSMA(closesReversed, 60).reverse();\nconst sma120 = calculateSMA(closesReversed, 120).reverse();\n\n// âœ… UTC æ—¶é—´æ ¼å¼åŒ–ï¼ˆç²¾ç¡®åˆ°å°æ—¶ï¼‰\nfunction formatUTCWithHour(ms) {\n  const d = new Date(ms);\n  const year = d.getUTCFullYear();\n  const month = String(d.getUTCMonth() + 1).padStart(2, '0');\n  const day = String(d.getUTCDate()).padStart(2, '0');\n  const hour = String(d.getUTCHours()).padStart(2, '0');\n  const minute = String(d.getUTCMinutes()).padStart(2, '0');\n  return `${year}-${month}-${day} ${hour}:${minute}`;\n}\n\n// âœ… è¾“å‡ºç»“æœï¼ˆindex: æœ€æ–°ä¸º1ï¼‰\nconst smaList = closes.map((close, i) => ({\n  index: i + 1,\n  date: formatUTCWithHour(timestamps[i]), // UTC+0ï¼Œç²¾ç¡®åˆ°å°æ—¶\n  close,\n  SMA14: sma14[i],\n  SMA28: sma28[i],\n  SMA60: sma60[i],\n  SMA120: sma120[i],\n}));\n\nreturn [\n  {\n    json: {\n      smaList,\n      total: limit,\n      note: \"UTC+0, with hour-level timestamp\"\n    }\n  }\n];\n"
      },
      "name": "sma14 28 60 120 1h",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -160,
        -40
      ],
      "id": "4f0a3eb8-42e5-4e9d-a0e5-a982a44f5f60"
    },
    {
      "parameters": {
        "functionCode": "// è·å– Bybit K çº¿åˆ—è¡¨ï¼ˆäºŒç»´æ•°ç»„ï¼‰\nconst klineList = $json.result.list;\n\n// æ”¶ç›˜ä»·å’Œæ—¶é—´æˆ³ï¼ˆåŸæ•°æ®æ˜¯ä»æ–°åˆ°æ—§ï¼‰\nconst closesOriginal = klineList.map(k => parseFloat(k[4]));\nconst timeOriginal = klineList.map(k => new Date(parseInt(k[0])));\n\n// âœ… ä¿®æ­£ï¼šåè½¬ä¸ºä»æ—§åˆ°æ–°è®¡ç®—\nconst closes = closesOriginal.slice().reverse();\nconst timestamps = timeOriginal.slice().reverse();\n\nconst limit = closes.length;\n\n// âœ… EMA è®¡ç®—å‡½æ•°ï¼ˆæ ‡å‡†æŒ‡æ•°ç§»åŠ¨å¹³å‡ï¼‰\nfunction EMA(data, period) {\n  const k = 2 / (period + 1);\n  const emaArray = [data[0]];\n  for (let i = 1; i < data.length; i++) {\n    emaArray.push(data[i] * k + emaArray[i - 1] * (1 - k));\n  }\n  return emaArray;\n}\n\n// âœ… æ ¼å¼åŒ– UTC æ—¶é—´åˆ° â€œYYYY-MM-DD HH:00â€\nfunction formatUTCDateToHour(dateObj) {\n  const iso = dateObj.toISOString(); // e.g., \"2025-04-20T01:00:00.000Z\"\n  const [date, time] = iso.split(\"T\");\n  const hour = time.split(\":\")[0];\n  return `${date} ${hour}:00`;\n}\n\n// âœ… MACD è®¡ç®—æ ¸å¿ƒæµç¨‹\nconst ema12 = EMA(closes, 12);\nconst ema26 = EMA(closes, 26);\nconst difArray = ema12.map((val, i) => val - ema26[i]);\nconst deaArray = EMA(difArray, 9);\nconst macdArray = difArray.map((val, i) => val - deaArray[i]);\n\n// âœ… è¾“å‡ºï¼ˆindex 0 æ˜¯æœ€æ–°ï¼‰\nconst macdList = difArray.map((_, i) => ({\n  index: limit - i,  // æœ€æ–°çš„æ˜¯ index 1\n  date: formatUTCDateToHour(timestamps[i]), // è½¬ä¸º UTC å°æ—¶çº§åˆ«æ ¼å¼\n  close: closes[i],\n  DIF: difArray[i].toFixed(4),\n  DEA: deaArray[i].toFixed(4),\n  histogram: macdArray[i].toFixed(4)\n})).reverse(); // âœ… æœ€ç»ˆå†åè½¬å›æ¥ï¼Œä¿è¯ index 0 æ˜¯æœ€æ–°\n\nreturn [\n  {\n    json: {\n      macdList,\n      total: limit\n    }\n  }\n];\n"
      },
      "name": "MACD 1h",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -160,
        120
      ],
      "id": "0a031616-b865-4f4c-acaa-a126eb047e3a"
    },
    {
      "parameters": {
        "functionCode": "// âœ… è·å– K çº¿æ•°æ®\nconst klineList = $json.result.list;\n\n// âœ… æå–æ”¶ç›˜ä»·å’Œæ—¶é—´æˆ³ï¼Œå¹¶åè½¬ä¸ºä»æ—§åˆ°æ–°\nconst closes = klineList.map(k => parseFloat(k[4])).reverse();\nconst timestamps = klineList.map(k => parseInt(k[0])).reverse();\n\nconst total = closes.length;\n\n// âœ… æ—¶é—´æ ¼å¼å‡½æ•°ï¼ˆUTC+0 ç²¾ç¡®åˆ°å°æ—¶ï¼‰\nfunction formatUTCHour(ms) {\n  const d = new Date(ms);\n  const year = d.getUTCFullYear();\n  const month = String(d.getUTCMonth() + 1).padStart(2, '0');\n  const day = String(d.getUTCDate()).padStart(2, '0');\n  const hour = String(d.getUTCHours()).padStart(2, '0');\n  const minute = String(d.getUTCMinutes()).padStart(2, '0');\n  return `${year}-${month}-${day} ${hour}:${minute}`;\n}\n\n// âœ… è®¡ç®— RSIï¼ˆä½¿ç”¨ RMA å¹³æ»‘ï¼‰\nfunction calculateRSI(closes, timestamps, period) {\n  const result = [];\n  let avgGain = 0, avgLoss = 0;\n\n  // åˆå§‹å¹³å‡å€¼ï¼ˆSMAï¼‰\n  for (let i = 1; i <= period; i++) {\n    const diff = closes[i] - closes[i - 1];\n    if (diff >= 0) avgGain += diff;\n    else avgLoss -= diff;\n  }\n\n  avgGain /= period;\n  avgLoss /= period;\n\n  let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;\n  let rsi = 100 - (100 / (1 + rs));\n\n  result.push({\n    index: period + 1,\n    date: formatUTCHour(timestamps[period]),\n    close: closes[period],\n    RSI: rsi.toFixed(2)\n  });\n\n  // é€’æ¨ï¼ˆRMA å¹³æ»‘ï¼‰\n  for (let i = period + 1; i < closes.length; i++) {\n    const diff = closes[i] - closes[i - 1];\n    const gain = diff > 0 ? diff : 0;\n    const loss = diff < 0 ? -diff : 0;\n\n    avgGain = (avgGain * (period - 1) + gain) / period;\n    avgLoss = (avgLoss * (period - 1) + loss) / period;\n\n    rs = avgLoss === 0 ? 100 : avgGain / avgLoss;\n    rsi = 100 - (100 / (1 + rs));\n\n    result.push({\n      index: i + 1,\n      date: formatUTCHour(timestamps[i]),\n      close: closes[i],\n      RSI: rsi.toFixed(2)\n    });\n  }\n\n  return result.reverse(); // âœ… æœ€æ–°åœ¨æœ€ä¸Š\n}\n\n// âœ… è¾“å‡º RSI14 å’Œ RSI30\nconst rsi14 = calculateRSI(closes, timestamps, 14);\nconst rsi30 = calculateRSI(closes, timestamps, 30);\n\nreturn [\n  {\n    json: {\n      rsi14,\n      rsi30,\n      method: \"RMA\",\n      total\n    }\n  }\n];\n"
      },
      "name": "RSI 1h",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -160,
        280
      ],
      "id": "c841fbd5-ac98-468d-ba3d-a01903dd286d"
    },
    {
      "parameters": {
        "functionCode": "// è·å–å®Œæ•´çš„ K çº¿æ•°æ®\nconst klineList = $json.result.list;\nconst symbol = $json.result.symbol || \"UNKNOWN\";\n\n// è‡ªåŠ¨æ¨æ–­ base assetï¼ˆå¦‚ ETHUSDT â†’ ETHï¼‰\nconst baseAsset = symbol.replace(/USDT$/i, \"\") || \"BaseAsset\";\n\n// è‡ªåŠ¨é€‚é…å‘¨æœŸæ•°é‡\nconst limit = klineList.length;\n\n// åˆå§‹åŒ–æ•°ç»„\nconst volumesBase = [];\nconst volumesUSDT = [];\nconst timestamps = [];\nconst detailedList = [];\n\n// æ—¶é—´æ ¼å¼ï¼ˆUTC ç²¾ç¡®åˆ°å°æ—¶ï¼‰\nfunction formatUTCHour(ms) {\n  const d = new Date(ms);\n  const year = d.getUTCFullYear();\n  const month = String(d.getUTCMonth() + 1).padStart(2, '0');\n  const day = String(d.getUTCDate()).padStart(2, '0');\n  const hour = String(d.getUTCHours()).padStart(2, '0');\n  return `${year}-${month}-${day} ${hour}:00`;\n}\n\n// éå†æ¯æ ¹Kçº¿\nfor (let i = 0; i < limit; i++) {\n  const item = klineList[i];\n  const timestamp = parseInt(item[0]);\n  const open = parseFloat(item[1]);\n  const close = parseFloat(item[4]);\n  const volumeBase = parseFloat(item[5]);\n  const avgPrice = (open + close) / 2;\n  const volumeUSDT = volumeBase * avgPrice;\n\n  volumesBase.push(volumeBase);\n  volumesUSDT.push(volumeUSDT);\n  timestamps.push(timestamp);\n\n  detailedList.push({\n    index: i + 1,\n    timeUTC: formatUTCHour(timestamp),\n    open,\n    close,\n    volumeBase,\n    volumeUSDT: volumeUSDT.toFixed(2),\n  });\n}\n\n// è®¡ç®—æ€»é‡ä¸å‡å€¼\nconst totalVolumeBase = volumesBase.reduce((a, b) => a + b, 0);\nconst avgVolumeBase = totalVolumeBase / volumesBase.length;\n\nconst totalVolumeUSDT = volumesUSDT.reduce((a, b) => a + b, 0);\nconst avgVolumeUSDT = totalVolumeUSDT / volumesUSDT.length;\n\nreturn [\n  {\n    json: {\n      baseAsset,\n      sampleSize: limit,\n      totalVolumeBase: totalVolumeBase.toFixed(2),\n      avgVolumeBase: avgVolumeBase.toFixed(2),\n      totalVolumeUSDT: totalVolumeUSDT.toFixed(2),\n      avgVolumeUSDT: avgVolumeUSDT.toFixed(2),\n      detailedVolumes: detailedList\n    }\n  }\n];\n"
      },
      "name": "Volume 1h",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -160,
        420
      ],
      "id": "beed1cd7-6775-464c-88f8-aeccaa6805bd"
    },
    {
      "parameters": {
        "jsCode": "const lang = $json.lang || \"zh\";\n\n// âœ… ä» JSON ä¸­æå–æ‰€æœ‰éœ€è¦çš„æ•°æ®\nconst kline = ($json.result?.list || []).slice().reverse();\nconst macdList = ($json.macdList || []).slice().reverse();\nconst rsiList = ($json.rsi14 || []).slice().reverse();\nconst smaList = ($json.smaList || []).slice().reverse();  // âœ… å¼•å…¥ SMA\n\nconst symbol = $json.symbol || \"UNKNOWN\";\nconst baseAsset = symbol.replace(/USDT|USDC|BUSD|TUSD|DAI|USD$/, \"\");\nconst limit = kline.length;\n\n// âœ… æœ€æ–°æ—¶é—´ï¼ˆUTC+0 ç²¾ç¡®å°æ—¶ï¼‰\nconst latestDate = new Date(parseInt(kline[limit - 1][0])).toISOString().replace(\"T\", \" \").slice(0, 16);\n\n// âœ… æ—¥æœŸæ˜ å°„ï¼ˆUTC+0 å°æ—¶ï¼‰\nconst dateMap = kline.map(k =>\n  new Date(parseInt(k[0])).toISOString().replace(\"T\", \" \").slice(0, 16)\n);\n\n// âœ… æ ¼å¼åŒ–å‡½æ•°ï¼šæ ¹æ®å€¼å¤§å°å†³å®šä¿ç•™çš„å°æ•°ä½æ•°\nconst formatValue = (value) => {\n  const numValue = Number(value); // Ensure the value is a number\n  if (isNaN(numValue)) return \"N/A\"; // Return 'N/A' if the value is not a number\n\n  if (numValue === 0) {\n    return \"0\";  // If value is 0, return \"0\"\n  } else if (numValue > 1 || numValue < -1) {\n    return numValue.toFixed(2);  // If value is >1 or < -1, keep 2 decimal places\n  } else {\n    return numValue.toFixed(7);  // If value is between -1 and 1, keep 7 decimal places\n  }\n};\n\n// âœ… Kçº¿æ•°æ®æ–‡æœ¬æ‹¼æ¥\nlet totalVolUSDT = 0;\nconst klineText = kline.map((item, i) => {\n  const date = dateMap[i];\n  const open = parseFloat(item[1]);\n  const high = parseFloat(item[2]);\n  const low = parseFloat(item[3]);\n  const close = parseFloat(item[4]);\n  const vol = parseFloat(item[5]);\n  const avgPrice = (open + close) / 2;\n  const volUSDT = avgPrice * vol;\n  totalVolUSDT += volUSDT;\n\n  return lang === \"zh\"\n    ? `${date}ï¼šå¼€ç›˜${open}Uï¼Œæœ€é«˜${high}Uï¼Œæœ€ä½${low}Uï¼Œæ”¶ç›˜${close}Uï¼Œæˆäº¤é‡â‰ˆ${volUSDT.toFixed(2)}USDT`\n    : `${date}: Open ${open}U, High ${high}U, Low ${low}U, Close ${close}U, Volume â‰ˆ${volUSDT.toFixed(2)}USDT`;\n}).join(\"\\n\");\n\nconst avgVolUSDT = totalVolUSDT / limit;\n\n// âœ… MACD è¾“å‡º\nconst macdText = macdList.length > 0\n  ? (lang === \"zh\"\n    ? `ã€MACD æŒ‡æ ‡ã€‘\\n` + macdList.map((item, i) =>\n        `${dateMap[i]}ï¼šDIF ${formatValue(item.DIF)}ï¼ŒDEA ${formatValue(item.DEA)}ï¼ŒæŸ±çŠ¶å›¾ ${formatValue(item.histogram)}`\n      ).join(\"\\n\")\n    : `ã€MACDã€‘\\n` + macdList.map((item, i) =>\n        `${dateMap[i]}: DIF ${formatValue(item.DIF)}, DEA ${formatValue(item.DEA)}, Histogram ${formatValue(item.histogram)}`\n      ).join(\"\\n\"))\n  : (lang === \"zh\" ? \"ã€MACD æŒ‡æ ‡ã€‘\\næš‚æ— æ•°æ®\" : \"ã€MACDã€‘\\nN/A\");\n\n// âœ… RSI è¾“å‡º\nconst rsiText = rsiList.length > 0\n  ? (lang === \"zh\"\n    ? `ã€RSI æŒ‡æ ‡ã€‘\\n` + rsiList.map(item =>\n        `${item.date}ï¼šæ”¶ç›˜ä»· ${item.close}Uï¼ŒRSI ${formatValue(item.RSI)}`\n      ).join(\"\\n\")\n    : `ã€RSIã€‘\\n` + rsiList.map(item =>\n        `${item.date}: Close ${item.close}U, RSI ${formatValue(item.RSI)}`\n      ).join(\"\\n\"))\n  : (lang === \"zh\" ? \"ã€RSI æŒ‡æ ‡ã€‘\\næš‚æ— æ•°æ®\" : \"ã€RSIã€‘\\nN/A\");\n\n// âœ… SMA è¾“å‡º\nconst smaText = smaList.length > 0\n  ? (lang === \"zh\"\n    ? `ã€SMA å‡çº¿ã€‘\\n` + smaList.map(item =>\n        `${item.date}ï¼šæ”¶ç›˜ä»· ${item.close}Uï¼ŒSMA14 ${formatValue(item.SMA14)}ï¼ŒSMA28 ${formatValue(item.SMA28)}ï¼ŒSMA60 ${formatValue(item.SMA60)}ï¼ŒSMA120 ${formatValue(item.SMA120)}`\n      ).join(\"\\n\")\n    : `ã€SMAã€‘\\n` + smaList.map(item =>\n        `${item.date}: Close ${item.close}U, SMA14 ${formatValue(item.SMA14)}, SMA28 ${formatValue(item.SMA28)}, SMA60 ${formatValue(item.SMA60)}, SMA120 ${formatValue(item.SMA120)}`\n      ).join(\"\\n\"))\n  : (lang === \"zh\" ? \"ã€SMA å‡çº¿ã€‘\\næš‚æ— æ•°æ®\" : \"ã€SMAã€‘\\nN/A\");\n\n// âœ… æˆäº¤é‡è¾“å‡º\nconst volumeText = lang === \"zh\"\n  ? `ã€æˆäº¤é‡ç»Ÿè®¡ã€‘\\nå‘¨æœŸï¼š${limit} æ ¹Kçº¿\\nå•ä½ï¼šæˆäº¤é¢ï¼ˆä¼°ç®—ï¼ŒUSDTï¼‰\\nå¹³å‡æˆäº¤é‡ï¼š${avgVolUSDT.toFixed(2)}U`\n  : `ã€Volume Statsã€‘\\nPeriod: ${limit} candles\\nUnit: Estimated USDT\\nAvg Volume: ${avgVolUSDT.toFixed(2)}U`;\n\n// âœ… åˆ†æè¯´æ˜\nconst promptHeader = lang === \"zh\"\n  ? `è¯·ä½¿ç”¨ç®€ä½“ä¸­æ–‡å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š\\n\\nğŸ‘‰ æ•°æ®è¯´æ˜ï¼šä»¥ä¸‹ K çº¿æ•°æ®æŒ‰æ—¶é—´ã€Œä»æ—§åˆ°æ–°ã€æ’åˆ—ï¼Œç¬¬ä¸€è¡Œä¸ºæœ€æ—©çš„æ—¶é—´ï¼Œæœ€åä¸€è¡Œæ˜¯å½“å‰æœ€æ–°æ•°æ®ã€‚\\n\\nè¯·åŸºäºä»¥ä¸‹ã€Œ1å°æ—¶çº§åˆ«ã€æ•°æ®ï¼ˆå…± ${limit} æ¡ï¼‰ï¼Œè¿›è¡Œå¸‚åœºæŠ€æœ¯åˆ†æï¼š`\n  : `Please answer in English:\\n\\nğŸ‘‰ Note: The K-line data is sorted from oldest to newest. The first row is the oldest, and the last row is the most recent.\\n\\nBased on the following 1-HOUR data (total ${limit} entries), provide technical market trend analysis:`;\n\n// âœ… åˆ†æä»»åŠ¡ï¼š1å°æ—¶ä¸“ç”¨\nconst askText = lang === \"zh\"\n  ? `è¯·ä½ åŸºäºä»¥ä¸Šã€Œ1å°æ—¶çº§åˆ«ã€æ•°æ®ï¼Œä»æŠ€æœ¯é¢çš„è§’åº¦è¿›è¡Œåˆ†æï¼š\n- æŠ¥å‘Š ${latestDate} å½“å‰æœ€æ–°ä»·æ ¼\n- åˆ¤æ–­çŸ­æœŸè¶‹åŠ¿ï¼ˆä¸Šæ¶¨/ä¸‹è·Œ/éœ‡è¡ï¼‰\n- æ˜¯å¦å‡ºç°çŸ­çº¿ä¹°å…¥/å–å‡ºä¿¡å·\n- RSI æ˜¯å¦å‡ºç° >80 è¶…ä¹°æˆ– <20 è¶…å–\n- MACD æ˜¯å¦çŸ­çº¿èƒŒç¦»\n- SMA æ˜¯å¦æ‹å¤´ã€æ’åˆ—ã€ç²˜åˆ\n- K çº¿æ˜¯å¦å‡ºç°å°¾ç›˜æ‹‰å‡ã€çŸ­çº¿çªç ´æˆ–ç›˜æ•´ä¿¡å·\n- å½“å‰æ˜¯å¦é€‚åˆå¿«è¿›å¿«å‡ºæ“ä½œ`\n  : `Based on the above 1-HOUR data:\n- Report the latest price as of ${latestDate}\n- Identify short-term trend (bullish/bearish/sideways)\n- Check for short-term buy/sell signals\n- Evaluate RSI for overbought (>80) or oversold (<20)\n- Identify short-term MACD divergence\n- Look for SMA signals like crossover, alignment, or consolidation\n- Identify breakout/consolidation or strong end-of-bar action\n- Evaluate if this zone is suitable for scalping or fast trades`;\n\nreturn [\n  {\n    json: {\n      aiPrompt: `${promptHeader}\\n\\nã€Kçº¿æ•°æ®ã€‘\\n${klineText}\\n\\n${macdText}\\n\\n${rsiText}\\n\\n${smaText}\\n\\n${volumeText}\\n\\n${askText}`\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        120
      ],
      "id": "c70ceea7-d019-4478-8716-d268aa46cf58",
      "name": "Format Prompt 1h"
    },
    {
      "parameters": {
        "url": "=https://api.bybit.com/v5/market/kline?category=linear&symbol={{$node[\"Set Variables\"].json[\"userInputUpper\"]}}&interval=60&limit=300",
        "options": {}
      },
      "name": "Fetch Kline 1h",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -320,
        20
      ],
      "id": "d53971ee-3621-4db4-8dbb-389f00a12e51"
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Set Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Variables": {
      "main": [
        [
          {
            "node": "Check Token in Array",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Valid?": {
      "main": [
        [
          {
            "node": "Valid Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Invalid Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid Response": {
      "main": [
        [
          {
            "node": "Fetch Kline 1h",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Token in Array": {
      "main": [
        [
          {
            "node": "IF Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Send Analysis To Telegram1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Model": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Send Analysis To Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge 2 (1D+1W)4": {
      "main": [
        [
          {
            "node": "Merge 2 (1D+1W)5",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge 2 (1D+1W)5": {
      "main": [
        [
          {
            "node": "Merge 2 (1D+1W)",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge 2 (1D+1W)6": {
      "main": [
        [
          {
            "node": "Merge 2 (1D+1W)5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge 2 (1D+1W)": {
      "main": [
        [
          {
            "node": "Format Prompt 1h",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sma14 28 60 120 1h": {
      "main": [
        [
          {
            "node": "Merge 2 (1D+1W)6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MACD 1h": {
      "main": [
        [
          {
            "node": "Merge 2 (1D+1W)6",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "RSI 1h": {
      "main": [
        [
          {
            "node": "Merge 2 (1D+1W)4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Volume 1h": {
      "main": [
        [
          {
            "node": "Merge 2 (1D+1W)4",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Format Prompt 1h": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Kline 1h": {
      "main": [
        [
          {
            "node": "Volume 1h",
            "type": "main",
            "index": 0
          },
          {
            "node": "RSI 1h",
            "type": "main",
            "index": 0
          },
          {
            "node": "MACD 1h",
            "type": "main",
            "index": 0
          },
          {
            "node": "sma14 28 60 120 1h",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge 2 (1D+1W)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "87791e2a-e177-4869-b7c6-f414a51b1100",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "a39d36c7743e7678f61d20c8c1b31ab7ab72a22d50653111a4fd7897da14076c"
  },
  "id": "IY7p3LMjnsKkTbPR",
  "tags": []
}